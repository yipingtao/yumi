<!DOCTYPE html>
<html xmlns:th="http://www.w3.org/1999/xhtml">
<head>
	<meta charset="utf-8"/>
	<title>layui</title>
	<meta name="renderer" content="webkit"/>
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1"/>
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
	<link rel="stylesheet" href="/js/layui/css/layui.css"  media="all"/>
	<!-- 注意：如果你直接复制所有代码到本地，上述css路径需要改成你本地的 -->
</head>
<body>

<div class="layui-row" style="margin: 10px">
	<form class="layui-form" action="">
		<div class="layui-form-item">
			<div class="layui-inline">
				<label class="layui-form-label">姓名</label>
				<div class="layui-input-inline">
					<input type="text" name="name"  autocomplete="off" class="layui-input"/>
				</div>
			</div>
			<div class="layui-inline">
				<label class="layui-form-label">性别</label>
				<div class="layui-input-inline">
					<input type="text" name="sex"  autocomplete="off" class="layui-input"/>
				</div>
			</div>
			<div class="layui-inline" >
				<button class="layui-btn layui-btn-normal" lay-submit="" lay-filter="demo1">搜索</button>
			</div>
		</div>
	</form>
</div>
<div class="layui-row">
	<table class="layui-hide" id="test"  lay-filter="test"></table>
	<script type="text/html" id="toolbarDemo">
		<div class="layui-btn-container">
			<button class="layui-btn layui-btn-sm" lay-event="addUser">新增</button>
		</div>
	</script>
	<script type="text/html" id="barDemo">
		<a class="layui-btn layui-btn-xs" lay-event="edit">编辑</a>
		<a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">删除</a>
	</script>
</div>

<script src="/js/layui/layui.js" charset="utf-8"></script>
<!-- 注意：如果你直接复制所有代码到本地，上述js路径需要改成你本地的 -->
<script src="/js/commonPath.js"></script>
<script type="text/javascript">
    layui.use(['table','form','layer','upload'], function(){
        var table = layui.table;
        var form = layui.form;
        var layer = layui.layer;
        var $ = layui.$;
		var upload  = layui.upload;
		var address = getAddress();

		$.fn.serializeObjects = function() {
			var o = {};
			var a = this.serializeArray();
			$.each(a, function() {
				if(o[this.name] !== undefined) {
					if(!o[this.name].push) {
						o[this.name] = [o[this.name]];
					}
					o[this.name].push(this.value || '');
				} else {
					o[this.name] = this.value || '';
				}
			});
			return o;
		};
        table.render({
            elem: '#test'
            ,url:'http://localhost:8088/user/getPageUserList'
			,toolbar: '#toolbarDemo'
            ,request: {
				//pageName: 'curr' //页码的参数名称，默认：page
                limitName: 'pageSize' //每页数据量的参数名，默认：limit
            }
			,method : 'post'
			,id : 'testReload'
            ,contentType: 'application/json'
            ,page: { //支持传入 laypage 组件的所有参数（某些参数除外，如：jump/elem） - 详见文档
                layout: ['limit', 'count', 'prev', 'page', 'next', 'skip'] //自定义分页布局
                //,curr: 5 //设定初始在第 5 页
                ,groups: 1 //只显示 1 个连续页码
                ,first: false //不显示首页
                ,last: false //不显示尾页
            },
			parseData: function(res){ //res 即为原始返回的数据
                return {
                    "code": res.resCode, //解析接口状态
                    "msg": res.resDesc, //解析提示文本
                    "count": res.data.total, //解析数据长度
                    "data": res.data.records //解析数据列表
                };
            }
            ,cols: [      //[[需要换行分开
            		[
                {field:'id',  title: 'ID', sort: true}
                ,{field:'name', title: '姓名'}
                ,{field:'sex',  title: '性别', sort: true}
                ,{field:'loginName', title: '登录名'}
                ,{field:'password', title: '密码'}
				,{fixed: 'right', title:'操作', toolbar: '#barDemo', width:150}
            ]
			]
        });



        //查询提交
        form.on('submit(demo1)', function(data){
//            layer.alert(JSON.stringify(data.field), {
//                title: '最终的提交信息'
//            });
            var dataField = data.field;
            table.reload('testReload', {
                url : 'http://localhost:8088/user/getPageUserList',
                where : { //设定异步数据接口的额外参数，任意设
                    name: dataField.name,
                    sex: dataField.sex
                },
                request: {
                  //  pageName: 'curr' //页码的参数名称，默认：page
                    limitName: 'pageSize' //每页数据量的参数名，默认：limit
                },
                method : 'post',
                contentType: 'application/json',
                page: {
                    curr: 1 //重新从第 1 页开始
                }
            });
        });

        form.on('submit(userForm)',function (data) {
			$.ajax({
				type: "Post",
				url: address+"/user/addUser",
				data: JSON.stringify(data.field),
				contentType: "application/json",
				dataType: "json",
				headers:{
					Authorization:localStorage.getItem("Authorization")
				},
				success: function(data) {
					reload();
					$('#userAddForm')[0].reset();
					layer.close(layer.index);
					layer.msg("添加成功");
				}
			});

		});
		//监听行工具事件
		table.on('tool(test)', function(obj){
			console.log(obj);
			var data = obj.data;
			if(obj.event === 'del'){
				layer.confirm('真的删除行么', function(index){
					obj.del();
					layer.close(index);
					//与服务器交互
					$.ajax({
						type: "post",
						url: address+"/user/delUserByids",
						data:JSON.stringify({"ids":[data.id]}),
						//防止深度序列化
						traditional: true,
						contentType: "application/json",
						dataType: "json",
						success: function(data) {

						}
					});
				});
			} else if(obj.event === 'edit'){
				//表单初始赋值
				form.val('userAddForm', data);
				$("#imgPhoto").attr("src",address+"/"+ data.photo);
				layer.open({
					type: 1,
					content: $('#userAdd'), //这里content是一个DOM，注意：最好该元素要存放在body最外层，否则可能被其它的相对元素所影响
					area:'500px',
					title:'编辑用户',
				});
			}
		});


		//头工具栏事件
		table.on('toolbar(test)', function(obj){
			var checkStatus = table.checkStatus(obj.config.id);
			switch(obj.event){
				case 'addUser':
					$('#userAddForm')[0].reset();
					$("#imgPhoto").attr("src","");
					layer.open({
						type: 1,
						content: $('#userAdd'), //这里content是一个DOM，注意：最好该元素要存放在body最外层，否则可能被其它的相对元素所影响
						area:'500px',
						title:'新增用户',
					});
					break;
			};
		});


		function reload() {
			table.reload('testReload', {
				url : 'http://localhost:8088/user/getPageUserList',
				request: {
					//  pageName: 'curr' //页码的参数名称，默认：page
					limitName: 'pageSize' //每页数据量的参数名，默认：limit
				},
				method : 'post',
				contentType: 'application/json',
				page: {
					curr: 1 //重新从第 1 页开始
				}
			});
		}

		//执行实例
		var uploadInst = upload.render({
			elem: '#uploadFile' //绑定元素
			,url: address +'/fileUpload/uploadSimple' //上传接口
			,done: function(res){
				if(res.resCode == "0000"){
                  $("#imgPhoto").attr("src",address+"/"+ res.data);
                  $("#photo").val(res.data);
				}else{
					layer.msg("上传异常")
				}
				//上传完毕回调
			},error: function(res){
				console.log(res);
				//请求异常回调
				// layer.msg("上传的异常");
			}
		});

    });
</script>

</body>


<div id="userAdd" hidden="hidden"  class="layui-row" style="margin: 10px">
	<form class="layui-form" action=""  id="userAddForm" lay-filter="userAddForm">
		<div class="layui-form-item">
			<label class="layui-form-label">姓名</label>
			<div class="layui-input-block">
				<input type="text" id="id" name="id" hidden="hidden"/>
				<input type="text" id="userName" name="name" required="required"  lay-verify="required" placeholder="请输入姓名" autocomplete="off" class="layui-input"/>
			</div>
		</div>
		<div class="layui-form-item" >
			<label class="layui-form-label">年龄</label>
			<div class="layui-input-block">
				<input type="text" name="age" id="userAge" value="0" required="required"  lay-verify="required" placeholder="请输入年龄" autocomplete="off" class="layui-input"/>
			</div>
		</div>
		<div class="layui-form-item">
			<label class="layui-form-label">登录名</label>
			<div class="layui-input-block">
				<input type="text" name="loginName" id="loginName" required="required"  lay-verify="required" placeholder="请输入登录名" autocomplete="off" class="layui-input"/>
			</div>
		</div>
		<div class="layui-form-item">
			<label class="layui-form-label">密码</label>
			<div class="layui-input-block">
				<input type="text" name="password" id="password" required="required"  lay-verify="required" placeholder="请输入密码" autocomplete="off" class="layui-input"/>
			</div>
		</div>
		<div class="layui-form-item">
			<label class="layui-form-label">单选框</label>
			<div class="layui-input-block">
				<input type="radio" name="sex" value="男" title="男" checked="checked"/>
				<input type="radio" name="sex" value="女" title="女" />
			</div>
		</div>
		<div class="layui-form-item">
			<label class="layui-form-label"><button type="button" class="layui-btn" id="uploadFile">上传头像</button></label>
			<div class="layui-input-block" >
				<img src="" id="imgPhoto" style="width: 100px;height: 100px"/>
				<input type="text" name="photo"  id="photo" hidden="hidden"/>
			</div>
		</div>
		<div class="layui-form-item">
			<label class="layui-form-label">地址</label>
			<div class="layui-input-block">
				<input type="text" name="address" id="address" required="required"  lay-verify="required" placeholder="请输入地址" autocomplete="off" class="layui-input"/>
			</div>
		</div>
		<div class="layui-form-item">
			<div class="layui-input-block">
				<button class="layui-btn" lay-submit="" lay-filter="userForm">立即提交</button>
				<button type="reset" class="layui-btn layui-btn-primary">重置</button>
			</div>
		</div>
	</form>
</div>
</html>